# =============================================================================
# Pose Transfer Configuration v7 (Ghost Legs Fix)
# =============================================================================

# [0] 입력 모드 설정
# --------------------------------------------------------
input_mode:
  type: "internal"

  internal:
    root_dir: "inputs"
    src_dir: "src"      # 소스 이미지가 있는 하위 폴더명
    ref_dir: "ref"      # 레퍼런스 이미지가 있는 하위 폴더명

  external:
    source_path: "/var/data/users/user_123.jpg"
    reference_path: "/var/data/poses/pose_dance.jpg"


# [1] 모델 설정
model:
  backend: "onnxruntime"
  device: "cuda"
  mode: "performance"
  to_openpose: false

# [2] 다중 인물 필터링
person_filter:
  enabled: true
  area_weight: 0.6
  center_weight: 0.4
  min_keypoints: 5
  confidence_threshold: 0.3

# [3] 손 정밀화
hand_refinement:
  enabled: true
  min_hand_size: 48
  max_scale_factor: 4.0

# =============================================================================
# [4] 포즈 전이 & Ghost Legs 클리핑 설정
# =============================================================================
transfer:
  normalization_base: "shoulder_width"
  confidence_threshold: 0.3
  
  # ============================================================
  # Ghost Legs 클리핑 설정
  # ============================================================
  # 
  # DWPose는 프레임에 보이지 않는 신체 부위도 "추정"하여 키포인트를 생성합니다.
  # 이로 인해 상반신만 있는 이미지에서도 허공에 다리가 그려지는 문제가 발생합니다.
  # 아래 설정으로 이러한 "유령 다리(Ghost Legs)"를 제거할 수 있습니다.
  #
  # ============================================================
  
  # [ON/OFF] Ghost Legs 클리핑 활성화
  # --------------------------------------------------------
  # true: 클리핑 적용 (권장)
  # false: 클리핑 비활성화 (DWPose 원본 그대로 사용)
  ghost_legs_clipping_enabled: true
  
  # [조절 1] 신뢰도 임계값 (lower_body_confidence_threshold)
  # --------------------------------------------------------
  # DWPose가 출력하는 각 키포인트의 신뢰도(confidence score) 기준입니다.
  # 이 값 미만의 신뢰도를 가진 하반신 키포인트는 "추정된 가짜"로 판단하여 제거합니다.
  #
  # 참고 - DWPose 신뢰도 범위:
  #   - 명확히 보이는 부위: 5.0 ~ 8.0+
  #   - 부분적으로 보이는 부위: 3.0 ~ 5.0
  #   - 추정된 부위 (안 보임): 0.5 ~ 2.0
  #   - 완전히 불확실: 0.5 미만
  #
  # 값 조절 가이드:
  #   - 3.0: 보수적 (확실히 안 보이는 것만 제거, 절삭 최소화)
  #   - 2.0: 균형 (기본값, 대부분의 경우 적절)
  #   - 1.5: 관대함 (약간 불확실해도 유지)
  #   - 1.0: 매우 관대함 (거의 절삭 안 함)
  #
  # 너무 많이 절삭된다면: 값을 낮추세요 (예: 2.0 → 1.5)
  # Ghost Legs가 남아있다면: 값을 높이세요 (예: 2.0 → 2.5)
  lower_body_confidence_threshold: 1.5
  
  # [조절 2] 경계 영역 비율 (lower_body_margin_ratio)
  # --------------------------------------------------------
  # 이미지 하단의 몇 %를 "프레임 밖 경계"로 간주할지 설정합니다.
  # 이 경계 안에 있는 하반신 키포인트는 "프레임 밖으로 나간 것"으로 판단하여 제거합니다.
  #
  # 계산 방식:
  #   boundary_y = 이미지높이 × (1 - margin_ratio)
  #   예: 이미지높이=1000, margin_ratio=0.10 → boundary_y=900
  #   → Y좌표가 900 이상인 하반신 키포인트는 제거
  #
  # 값 조절 가이드:
  #   - 0.05 (5%): 매우 관대함 (맨 아래 가장자리만 제거)
  #   - 0.10 (10%): 균형 (기본값)
  #   - 0.15 (15%): 보수적 (더 많이 제거)
  #   - 0.20 (20%): 매우 보수적 (하단 1/5 영역 제거)
  #
  # 발이 잘린다면: 값을 낮추세요 (예: 0.10 → 0.05)
  # 하단 Ghost Legs가 남아있다면: 값을 높이세요 (예: 0.10 → 0.12)
  lower_body_margin_ratio: 0.025
  
  # [조절 3] 화면 밖 허용 범위 (visibility_margin)
  # --------------------------------------------------------
  # 전이(transfer) 후 최종 결과에서, 화면 밖으로 얼마나 벗어난 키포인트까지 허용할지 설정합니다.
  # (이 설정은 전이 시에만 적용되며, 단순 추출에는 영향 없음)
  #
  # 계산 방식:
  #   limit = 이미지크기 × (1 + visibility_margin)
  #   예: 이미지높이=1000, margin=0.15 → limit=1150
  #   → Y좌표가 1150 이상이면 제거
  #
  # 값 조절 가이드:
  #   - 0.10: 보수적 (화면 밖 10%까지만 허용)
  #   - 0.15: 균형 (기본값)
  #   - 0.20: 관대함 (화면 밖 20%까지 허용)
  visibility_margin: 0.2


# [5] 폴백 전략
fallback:
  symmetric_mirror: true
  hierarchical_estimation: true
  fallback_confidence_decay: 0.5

# [6] 렌더링 스타일
rendering:
  line_thickness: 4
  face_line_thickness: 4
  hand_line_thickness: 4
  point_radius: 2
  background_color: [0, 0, 0]
  kpt_threshold: 0.1

# [7] 출력 설정
output:
  save_json: true
  save_skeleton_image: true
  save_debug_image: false

# [8] 시스템 설정
system:
  enable_archiving: false

# [9] 얼굴 부위별 렌더링 제어
face_rendering:
  enabled: true
  
  parts:
    jawline:
      enabled: false
      color: [255, 255, 255]
    left_eyebrow:
      enabled: true
      color: [255, 255, 255]
    right_eyebrow:
      enabled: true
      color: [255, 255, 255]
    nose:
      enabled: true
      color: [255, 255, 255]
    left_eye:
      enabled: true
      color: [255, 255, 255]
    right_eye:
      enabled: true
      color: [255, 255, 255]
    mouth_outer:
      enabled: true
      color: [255, 255, 255]
    mouth_inner:
      enabled: true
      color: [255, 255, 255]